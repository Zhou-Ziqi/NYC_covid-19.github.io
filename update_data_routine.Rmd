---
title: "How to update data"
author: "Ziqi Zhou"
date: "8/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
library(curl)
library(lubridate)
```

# Date change
```{r}
#today = Sys.Date()
today = as.Date("2020-08-24")

yesterday = today - 1

```



# Daily Update
## Use 2020-08-19 as example
### Tracker, Distribution Map
Just need to download the raw data(data-by-modzcta0819.csv).(add the date!)
```{r}
x <- read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/data-by-modzcta.csv")) 
#write_csv(x,paste0("./data/data_for_table/data-by-modzcta",month(today),day(today),".csv")) 
write_csv(x,paste0("nyc-neighborhoods-covid/data/data_for_table/data-by-modzcta",month(today),day(today),".csv")) 
```
And then change path in the app.R code.

search the "data_yester" and "data_today" change the date

### Time Trend
Also the "data-by-modzcta0819.csv"

```{r}
data_yester = read_csv(paste0("nyc-neighborhoods-covid/data/data_for_table/data-by-modzcta",month(yesterday),day(yesterday),".csv")) %>% 
  janitor::clean_names() %>% 
  mutate(date = as.Date(yesterday)) 
data_today = read_csv(paste0("nyc-neighborhoods-covid/data/data_for_table/data-by-modzcta",month(today),day(today),".csv")) %>% 
  janitor::clean_names() %>% 
  mutate(date = as.Date(today))

data_tracker = rbind(data_today,data_yester)
new_case = 0
new_death = 0

for (i in 1:177) {
  new_case[i] = data_tracker[i,4] - data_tracker[i+177,4]
  new_case
  
  new_death[i] = data_tracker[i,7] - data_tracker[i+177,7]
  new_death
}

for (i in 178:354) {
  
  new_case[i] = NA
  
  new_death[i] = NA
}

data_today = data_tracker %>% 
  mutate(new_case = new_case,
         new_death = new_death) %>% 
  filter(date == max(date)) %>% 
  mutate(newcases = as.numeric(new_case),
         new_death = as.numeric(new_death) )%>% 
  rename(zipcode = modified_zcta,
         positive  = covid_case_count,
         day = date) %>% mutate(pop_denominator = round(pop_denominator),
         incidence_rate = (newcases/pop_denominator)*100000) %>%
  select(zipcode,day,neighborhood_name,borough_group, positive,covid_case_rate, covid_death_count, covid_death_rate,incidence_rate,newcases,pop_denominator)

newdata = read_csv(paste0("nyc-neighborhoods-covid/data/modzcta_until",month(yesterday),day(yesterday),".csv")) %>% 
  mutate(pop_denominator = round(pop_denominator),
         incidence_rate = (newcases/pop_denominator)*100000) %>%
  select(zipcode,day,neighborhood_name,borough_group, positive,covid_case_rate, covid_death_count, covid_death_rate,incidence_rate,newcases,pop_denominator)

newdata = rbind(newdata,data_today)
#write_csv(newdata,paste0("./data/modzcta_until",month(today),day(today),".csv"))
write_csv(newdata,paste0("nyc-neighborhoods-covid/data/modzcta_until",month(today),day(today),".csv"))


```


Aug19data <- read_csv("data/Aug19data.csv") %>% 
  select(zipcode,day,neighborhood_name,borough_group, positive,covid_case_rate, covid_death_count, covid_death_rate,newcases)

### COVID-19 by demo

#### byage

```{r}
byage = read_csv(paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demoage_until",month(yesterday),day(yesterday),".csv")) # 

byage_new = read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/boro/boroughs-by-age.csv")) %>% 
 pivot_longer(BK_CASE_COUNT:SI_DEATH_RATE,
               names_to = "location_n_event",
               values_to = "count")%>% 
  mutate(day = today, 
         day = as.Date(day))%>% separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

byage = rbind(byage, byage_new)

#write_csv(byage,paste0("./distribution_of_covid-19/data/demoage_until",month(today),day(today),".csv")) 
write_csv(byage,paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demoage_until",month(today),day(today),".csv")) 
#write_csv(byage,"nyc-neighborhoods-covid/distribution_of_covid-19/data/demoage_data.csv")
```

#### by race
```{r}
byrace = read_csv(paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demorace_until",month(yesterday),day(yesterday),".csv"))

byrace_new = read_csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/boro/boroughs-by-race.csv")) %>% 
  pivot_longer(BK_CASE_COUNT:SI_DEATH_RATE_ADJ,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)
byrace = rbind(byrace, byrace_new)

#write_csv(byrace,paste0("./distribution_of_covid-19/data/demorace_until",month(today),day(today),".csv")) 
write_csv(byrace,paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demorace_until",month(today),day(today),".csv")) 
#write_csv(byrace,"nyc-neighborhoods-covid/distribution_of_covid-19/data/BYRACE_demoage_data.csv") 
```

#### by sex
```{r}
#bysex = read_csv(paste0("./distribution_of_covid-19/data/demosex_until",month(yesterday),day(yesterday),".csv")) 
bysex = read_csv("nyc-neighborhoods-covid/distribution_of_covid-19/data/demoage_data_sex.csv") 


bysex_new = read_csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/boro/boroughs-by-sex.csv")) %>% 
  pivot_longer(BK_CASE_COUNT:SI_DEATH_RATE,
               names_to = "location_n_event",
               values_to = "count")%>% 
  mutate(day = today,
         day = as.Date(day))%>% separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)
bysex = rbind(bysex, bysex_new)
#write_csv(bysex,paste0("./distribution_of_covid-19/data/demosex_until",month(today),day(today),".csv")) 
write_csv(bysex,paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demosex_until",month(today),day(today),".csv")) 
#write_csv(bysex,"nyc-neighborhoods-covid/distribution_of_covid-19/data/demoage_data_sex.csv") 
```





# Weekly Update
```{r}
boroughs_case_hosp_death <- read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/boro/boroughs-case-hosp-death.csv")) %>% janitor::clean_names()
```

Download: "coronavirus-data/boro/boroughs-case-hosp-death.csv" add the date; change the path and run the code below


```{r}
bk <- boroughs_case_hosp_death %>% 
  select(date_of_interest, starts_with("bk")) %>% 
  mutate(boro = "Brooklyn")
names(bk) <- str_replace(colnames(bk),"bk_","")
bk <- bk %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

bx <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("bx")) %>% mutate(boro = "Bronx")
names(bx) <- str_replace(colnames(bx),"bx_","")
bx <- bx %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

mn <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("mn")) %>% mutate(boro = "Manhattan")
names(mn) <- str_replace(colnames(mn),"mn_","")
mn <- mn %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

qn <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("qn")) %>% mutate(boro = "Queens")
names(qn) <- str_replace(colnames(qn),"qn_","")
qn <- qn %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

si <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("si")) %>% mutate(boro = "Staten Island")
names(si) <- str_replace(colnames(si),"si_","")
si <- si %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

borocase <- rbind(bk,bx,mn,qn,si) %>% 
  separate(date_of_interest, into = c("mon", "day", "year"),sep = '/') %>% 
  mutate(date_of_interest = as.Date(with(., paste(year, mon, day,sep="-")), "%Y-%m-%d")) %>%
  select(date_of_interest, boro,everything(), -c(mon,day,year))
  

borocase_new <- borocase %>% select(-starts_with("cum"))
borocase_cum <- borocase %>% select(date_of_interest, boro, starts_with("cum"))

write.csv(borocase_new, "nyc-neighborhoods-covid/data/boro_newcase_trend.csv")
write.csv(borocase_cum, "nyc-neighborhoods-covid/data/boro_cumcase_trend.csv")
#write.csv(borocase_new, "data/boro_newcase_trend.csv")
#write.csv(borocase_cum, "data/boro_cumcase_trend.csv")
```

