---
title: "How to update data"
author: "Ziqi Zhou"
date: "8/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
library(curl)
library(lubridate)
```

# Date change
```{r}
#today = Sys.Date()
today = as.Date("2020-12-12")

yesterday = today - 1

```



# Daily Update
## summary

```{r}
yessum = read.csv(paste0("nyc-neighborhoods-covid/data/summarytable/summary",month(yesterday),day(yesterday),".csv"))
```



```{r}
sum <- read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/totals/summary.csv"))
sum = sum %>% 
  janitor::clean_names() %>% 
  mutate(measure = str_replace_all(measure,"NYC_CASE_COUNT","Cumulative Case Count"),
         measure = str_replace_all(measure,"NYC_HOSPITALIZED_COUNT","Cumulative Hospitalization Count"),
         measure = str_replace_all(measure,"NYC_CONFIRMED_DEATH_COUNT","Cumulative Confirmed Death Count"),
         measure = str_replace_all(measure,"NYC_PROBABLE_DEATH_COUNT","Cumulative Probable Death Count"),
         measure = str_replace_all(measure,"DATE_UPDATED","Date updated"),
         measure = str_replace_all(measure,"NYC_PROBABLE_CASE_COUNT","Probable Case Count"),
         measure = str_replace_all(measure,"NYC_TOTAL_CASE_COUNT","Total Case Count"),
         measure = str_replace_all(measure,"NYC_TOTAL_DEATH_COUNT","Total Death Count")) %>% 
  rename("Measure" = "measure",
         "Count" = number_of_nyc_residents)
#knitr::kable(sum,col.names  = c(" "," "))
write_csv(sum,paste0("nyc-neighborhoods-covid/data/summarytable/summary",month(today),day(today),".csv") )
write_csv(sum,"draft/data/summary.csv")
```


```{r}
new_sum = sum
new_sum[,1] = c("New Case Count","New Probable Case Count","New Case Count2",
                "New Hospitalization Count",
                "New Comfirmed Death Count","New Probable Death Count","New Death Count",
                "Date updated")
new_sum[,2] = as.character(new_sum[,2])
for (i in 1:7) {
  new_sum[i,2] = as.numeric(as.character(sum[i,2])) - as.numeric(as.character(yessum[i,2])) 
}

new_sum[8,2] = sum[8,2]
```


## Use 2020-08-19 as example
### Tracker, Distribution Map
Just need to download the raw data(data-by-modzcta0819.csv).(add the date!)
```{r}
#https://github.com/nychealth/coronavirus-data/blob/master/totals/data-by-modzcta.csv
x <- read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/totals/data-by-modzcta.csv")) 
#write_csv(x,paste0("draft/data/data_for_table/data-by-modzcta",month(today),day(today),".csv")) 
write_csv(x,paste0("nyc-neighborhoods-covid/data/data_for_table/data-by-modzcta",month(today),day(today),".csv")) 
```
And then change path in the app.R code.

search the "data_yester" and "data_today" change the date

### Time Trend
Also the "data-by-modzcta0819.csv"

```{r}
data_yester = read_csv(paste0("nyc-neighborhoods-covid/data/data_for_table/data-by-modzcta",month(yesterday),day(yesterday),".csv")) %>% 
  janitor::clean_names() %>% 
  mutate(date = as.Date(yesterday))  %>% 
  drop_na()
data_today = read_csv(paste0("nyc-neighborhoods-covid/data/data_for_table/data-by-modzcta",month(today),day(today),".csv")) %>% 
  janitor::clean_names() %>% 
  mutate(date = as.Date(today)) %>% 
  drop_na()

data_tracker = rbind(data_today,data_yester)
new_case = 0
new_death = 0

for (i in 1:177) {
  new_case[i] = data_tracker[i,4] - data_tracker[i+177,4]
  new_case
  
  new_death[i] = data_tracker[i,7] - data_tracker[i+177,7]
  new_death
}

for (i in 178:354) {
  
  new_case[i] = NA
  
  new_death[i] = NA
}

data_today = data_tracker %>% 
  mutate(new_case = new_case,
         new_death = new_death) %>% 
  filter(date == max(date)) %>% 
  mutate(newcases = as.numeric(new_case),
         new_death = as.numeric(new_death) )%>% 
  rename(zipcode = modified_zcta,
         positive  = covid_case_count,
         day = date) %>% mutate(pop_denominator = round(pop_denominator),
         incidence_rate = (newcases/pop_denominator)*100000) %>%
  select(zipcode,day,neighborhood_name,borough_group, positive,covid_case_rate, covid_death_count, covid_death_rate,incidence_rate,newcases,pop_denominator)

newdata = read_csv(paste0("nyc-neighborhoods-covid/data/modzcta_until",month(yesterday),day(yesterday),".csv")) %>% 
  mutate(pop_denominator = round(pop_denominator),
         incidence_rate = (newcases/pop_denominator)*100000) %>%
  select(zipcode,day,neighborhood_name,borough_group,everything())

newdata = rbind(newdata,data_today)
#write_csv(newdata,paste0("draft/data/modzcta_until",month(today),day(today),".csv"))
write_csv(newdata,paste0("nyc-neighborhoods-covid/data/modzcta_until",month(today),day(today),".csv"))

```

### COVID-19 by demo

# New 
```{r}
#get data
groupbycase = read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/totals/group-cases-by-boro.csv"))

groupbydeath = read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/totals/group-death-by-boro.csv"))

groupbyhosp = read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/totals/group-hosp-by-boro.csv"))
```


```{r}
#byage = read_csv("/Users/ziqizhou/Desktop/MSPH_1st_Year/P8105_Data_Science/Git/NYC_covid-19.github.io/nyc-neighborhoods-covid/distribution_of_covid-19/data/demoage_until118.csv") 

casebyage = groupbycase %>% filter(group =="Age") %>% 
  pivot_longer(BK_CASE_COUNT:SI_CASE_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

deathbyage = groupbydeath %>% filter(group =="Age") %>% 
  pivot_longer(BK_DEATH_COUNT:SI_DEATH_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

hospbyage = groupbyhosp %>% filter(group =="Age") %>% 
  pivot_longer(BK_HOSPITALIZED_COUNT:SI_HOSPITALIZED_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

byagetoday = rbind(casebyage,deathbyage)
byagetoday = rbind(byagetoday,hospbyage)
write_csv(byagetoday,paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demoage_today",month(today),day(today),".csv")) 
```


```{r}
casebyrace = groupbycase %>% filter(group =="Race/ethnicity") %>% 
  pivot_longer(BK_CASE_COUNT:SI_CASE_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)
deathbyrace = groupbydeath %>% filter(group =="Race/ethnicity") %>% 
  pivot_longer(BK_DEATH_COUNT:SI_DEATH_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

hospbyrace = groupbyhosp %>% filter(group =="Race/ethnicity") %>% 
  pivot_longer(BK_HOSPITALIZED_COUNT:SI_HOSPITALIZED_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

byracetoday = rbind(casebyrace,deathbyrace)
byracetoday = rbind(byracetoday,hospbyrace)
write_csv(byracetoday,paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demorace_today",month(today),day(today),".csv")) 
```

```{r}
casebysex = groupbycase %>% filter(group =="Sex") %>% 
  pivot_longer(BK_CASE_COUNT:SI_CASE_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

deathbysex = groupbydeath %>% filter(group =="Sex") %>% 
  pivot_longer(BK_DEATH_COUNT:SI_DEATH_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

hospbysex = groupbyhosp %>% filter(group =="Sex") %>% 
  pivot_longer(BK_HOSPITALIZED_COUNT:SI_HOSPITALIZED_RATE,
               names_to = "location_n_event",
               values_to = "count") %>% 
  mutate(day = today,
         day = as.Date(day)) %>% 
  separate(location_n_event,
                   into = c("location","outcome"),sep = 3) %>% 
  separate(location, into = c("boro", "x"),sep = 2) %>% 
  dplyr:: select(-x)

bysextoday = rbind(casebysex,deathbysex)
bysextoday = rbind(bysextoday,hospbysex)
write_csv(bysextoday,paste0("nyc-neighborhoods-covid/distribution_of_covid-19/data/demosex_today",month(today),day(today),".csv")) 

```


# Antibody

```{r}
antibody = read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/totals/antibody-by-modzcta.csv"))

antibody = antibody %>% janitor::clean_names()
write_csv(antibody,paste0("nyc-neighborhoods-covid/data/antibody_zcta",month(today),day(today),".csv"))
```




# Weekly Update
```{r}
boroughs_case_hosp_death <- read.csv(curl("https://raw.github.com/nychealth/coronavirus-data/master/trends/data-by-day.csv")) %>% janitor::clean_names()
write.csv(boroughs_case_hosp_death,"nyc-neighborhoods-covid/data/data-by-day.csv")
```

Download: "coronavirus-data/boro/boroughs-case-hosp-death.csv" add the date; change the path and run the code below


```{r}
bk <- boroughs_case_hosp_death %>% 
  select(date_of_interest, starts_with("bk")) %>% 
  mutate(boro = "Brooklyn")
names(bk) <- str_replace(colnames(bk),"bk_","")
bk <- bk %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

bx <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("bx")) %>% mutate(boro = "Bronx")
names(bx) <- str_replace(colnames(bx),"bx_","")
bx <- bx %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

mn <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("mn")) %>% mutate(boro = "Manhattan")
names(mn) <- str_replace(colnames(mn),"mn_","")
mn <- mn %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

qn <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("qn")) %>% mutate(boro = "Queens")
names(qn) <- str_replace(colnames(qn),"qn_","")
qn <- qn %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

si <- boroughs_case_hosp_death %>% select(date_of_interest, starts_with("si")) %>% mutate(boro = "Staten Island")
names(si) <- str_replace(colnames(si),"si_","")
si <- si %>% mutate(cum_case_count = cumsum(case_count),
         cum_hospitalized_count = cumsum(hospitalized_count),
         cum_death_count = cumsum(death_count))

borocase <- rbind(bk,bx,mn,qn,si) %>% 
  separate(date_of_interest, into = c("mon", "day", "year"),sep = '/') %>% 
  mutate(date_of_interest = as.Date(with(., paste(year, mon, day,sep="-")), "%Y-%m-%d")) %>%
  select(date_of_interest, boro,everything(), -c(mon,day,year))
  

borocase_new <- borocase %>% select(-starts_with("cum"))
borocase_cum <- borocase %>% select(date_of_interest, boro, starts_with("cum"))

write.csv(borocase_new, "nyc-neighborhoods-covid/data/boro_newcase_trend.csv")
write.csv(borocase_cum, "nyc-neighborhoods-covid/data/boro_cumcase_trend.csv")
#write.csv(borocase_new, "projection/data/boro_newcase_trend.csv")
#write.csv(borocase_cum, "projection/data/boro_cumcase_trend.csv")
#write.csv(borocase_new, "data/boro_newcase_trend.csv")
#write.csv(borocase_cum, "data/boro_cumcase_trend.csv")
```

